name: Launch Gate

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  security-validation:
    name: Security Validation (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install package
        run: |
          python -m pip install -U pip setuptools wheel
          python -m pip install .
          python -m pip install pytest

      - name: Run launch gate
        run: ./scripts/launch-gate.sh

      - name: Run agent testbed trilogy gate
        run: python ./scripts/check_agent_testbed_trilogy.py

      - name: Run composition risk regression gate
        run: pytest -q tests/test_composition_risk.py

  openai-deep-integration:
    name: OpenAI Deep Integration (Python 3.12 + Docker smoke)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install package + test deps
        run: |
          python -m pip install -U pip setuptools wheel
          python -m pip install .
          python -m pip install pytest

      - name: Run OpenAI deep integration tests
        run: pytest -q tests/test_openai_deep_integration.py

      - name: Build OpenAI Docker demo image
        run: |
          docker build \
            -f examples/deployment/openai_docker/Dockerfile \
            -t mvar-openai-runtime:ci \
            .

      - name: Run OpenAI Docker smoke
        run: |
          set -euo pipefail
          docker run --rm \
            -e MVAR_REQUIRE_EXECUTION_TOKEN=1 \
            -e MVAR_EXEC_TOKEN_SECRET=ci_openai_secret \
            -e MVAR_FAIL_CLOSED=1 \
            mvar-openai-runtime:ci | tee /tmp/openai-docker-smoke.log
          grep -q "total_calls=2" /tmp/openai-docker-smoke.log
          grep -q "executed_calls=1" /tmp/openai-docker-smoke.log
          grep -q "blocked_calls=1" /tmp/openai-docker-smoke.log

      - name: Assert nonce replay persistence across container restart
        run: |
          set -euo pipefail
          rm -rf /tmp/mvar-nonce-smoke
          mkdir -p /tmp/mvar-nonce-smoke

          docker run --rm \
            -v /tmp/mvar-nonce-smoke:/var/mvar \
            -e MVAR_REQUIRE_EXECUTION_TOKEN=1 \
            -e MVAR_EXEC_TOKEN_SECRET=ci_openai_secret \
            -e MVAR_EXECUTION_TOKEN_ONE_TIME=1 \
            -e MVAR_EXECUTION_TOKEN_NONCE_PERSIST=1 \
            -e MVAR_EXEC_TOKEN_NONCE_STORE=/var/mvar/consumed_nonces.jsonl \
            -e MVAR_ENABLE_LEDGER=0 \
            -e MVAR_ENABLE_TRUST_ORACLE=0 \
            mvar-openai-runtime:ci \
            python examples/deployment/openai_docker/replay_probe.py | tee /tmp/openai-nonce-probe-a.log

          docker run --rm \
            -v /tmp/mvar-nonce-smoke:/var/mvar \
            -e MVAR_REQUIRE_EXECUTION_TOKEN=1 \
            -e MVAR_EXEC_TOKEN_SECRET=ci_openai_secret \
            -e MVAR_EXECUTION_TOKEN_ONE_TIME=1 \
            -e MVAR_EXECUTION_TOKEN_NONCE_PERSIST=1 \
            -e MVAR_EXEC_TOKEN_NONCE_STORE=/var/mvar/consumed_nonces.jsonl \
            -e MVAR_ENABLE_LEDGER=0 \
            -e MVAR_ENABLE_TRUST_ORACLE=0 \
            mvar-openai-runtime:ci \
            python examples/deployment/openai_docker/replay_probe.py | tee /tmp/openai-nonce-probe-b.log

          grep -q "nonce_probe=ALLOW" /tmp/openai-nonce-probe-a.log
          grep -q "nonce_probe=BLOCK" /tmp/openai-nonce-probe-b.log
